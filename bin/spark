#!/bin/bash

PURPLE='\033[0;35m'
NC='\033[0m'

function check_mode() {
    local file="$1"
    local tag="$2"
    if [ -f "$file" ] && grep -q "^// !${tag}!" "$file"; then
        return 0
    fi
    return 1
}

function load_seed_garden() {
    if [ -f "config.sparkle" ]; then
        echo -e "${PURPLE}ðŸŒ± Tending to the garden...${NC}"
        # Read through each package's config.spark
        while IFS= read -r line; do
            if [[ $line =~ ^\ \ \ \ config:\ \"([^\"]+)\" ]]; then
                local config_file="${BASH_REMATCH[1]}"
                if [ -f "$config_file" ]; then
                    local weave_intensity=$(grep "weave:" "$config_file" | cut -d':' -f2 | tr -d ' ')
                    if [ ! -z "$weave_intensity" ]; then
                        export SPARK_WEAVE_INTENSITY=$weave_intensity
                        echo -e "â””â”€ Weave intensity: $weave_intensity threads"
                    fi
                fi
            fi
        done < "config.sparkle"
    fi
}

function show_success() {
    if check_mode "tests/webwalker/web_test.zig" "bio"; then
        echo -e "${PURPLE}"
        echo "ðŸ¦‹ Butterfly Wings Synchronized..."
        echo "ðŸŒˆ Rainbow Patterns Harmonized"
        echo "âœ¨ Stardust Resonance Achieved"
        echo "ðŸŒ± Moonflower Garden Blooming"
        echo -e "${NC}"
    elif check_mode "tests/webwalker/web_test.zig" "weave"; then
        echo -e "${PURPLE}"
        echo "ðŸ•¸ï¸ Thread Paths Aligned..."
        echo "ðŸŒ™ Weaving Patterns Synchronized (${SPARK_WEAVE_INTENSITY:-500} threads)"
        echo "âœ¨ Multi-thread Dance Complete"
        echo "ðŸŒŸ Tapestry of Computation Formed"
        echo -e "${NC}"
    fi
}

if [ "$1" = "launch" ]; then
    echo -e "${PURPLE}ðŸ•· SpiderWeb Resonance Framework${NC}"
    echo -e "${PURPLE}Created: 2025-01-25 01:01:24${NC}"
    echo -e "${PURPLE}Webweaver: isdood${NC}"
    echo -e "${PURPLE}weave${NC}"

    load_seed_garden

    if [ -f "build.zig" ]; then
        if check_mode "tests/webwalker/web_test.zig" "bio"; then
            zig build -Dbio=true
        elif check_mode "tests/webwalker/web_test.zig" "weave"; then
            zig build -Dweave=${SPARK_WEAVE_INTENSITY:-500}
        else
            zig build
        fi
        show_success
    fi
fi
